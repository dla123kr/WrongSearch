using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using System.Xml.Serialization;
using System.IO;

using System.Threading;
using System.Net;
using System.Net.Sockets;

using WrongSearch_Server.Class;

namespace WrongSearch_Server
{
    public partial class ServerForm : Form
    {
        private TcpListener serverSocket = null;
        private TcpClient clientSocket = null;

        public List<clsPerson> member = new List<clsPerson>();

        public int connectCnt = 0;

        public ServerForm()
        {
            InitializeComponent();
        }

        private void ServerForm_Load(object sender, EventArgs e)
        {
            lbIP.Text = GetIP();
            member = XMLDeserialize("memberDB.xml");

            Thread thr = new Thread(new ThreadStart(ListenClient));
            thr.Start();
        }

        public void XMLSerialize(List<clsPerson> list, String filename)
        {
            XmlSerializer serializer = null;
            FileStream stream = null;
            try
            {
                serializer = new XmlSerializer(typeof(List<clsPerson>));
                stream = new FileStream(filename, FileMode.Create, FileAccess.Write);
                serializer.Serialize(stream, list);
            }
            finally
            {
                if (stream != null)
                    stream.Close();
            }
        }

        public static List<clsPerson> XMLDeserialize(String filename)
        {
            XmlSerializer serializer = null;
            FileStream stream = null;
            List<clsPerson> list = new List<clsPerson>();
            try
            {
                serializer = new XmlSerializer(typeof(List<clsPerson>));
                stream = new FileStream(filename, FileMode.Open);
                list = (List<clsPerson>)serializer.Deserialize(stream);
            }
            catch { }
            finally
            {
                if (stream != null)
                    stream.Close();
            }
            return list;
        }

        private string GetIP()
        {
            IPHostEntry host = Dns.GetHostEntry(Dns.GetHostName());
            string ip = null;
            for (int i = 0; i < host.AddressList.Length; i++)
            {
                if (host.AddressList[i].AddressFamily == AddressFamily.InterNetwork)
                    ip = host.AddressList[i].ToString();
            }
            return ip;
        }

        private void ListenClient()
        {
            serverSocket = new TcpListener(IPAddress.Any, 8088);
            serverSocket.Start();

            while (true)
            {
                clientSocket = serverSocket.AcceptTcpClient();
                connectCnt++;

                handleClient client = new handleClient(this);
                client.startClient(clientSocket, connectCnt.ToString());
            }
        }

        private void ServerForm_FormClosing(object sender, FormClosingEventArgs e)
        {
            Application.ExitThread();
            Environment.Exit(0);
        }
    }

    public class handleClient
    {
        ServerForm serverForm = null;

        TcpClient clientSocket;
        string clNo;

        public handleClient(ServerForm sf)
        {
            serverForm = sf;
        }


        public void startClient(TcpClient inClientSocket, string clineNo)
        {
            this.clientSocket = inClientSocket;
            this.clNo = clineNo;
            Thread recvThr = new Thread(RecvBuffer);
            recvThr.Start();
        }
        
        private void RecvBuffer()
        {
            while (true)
            {
                byte[] buf = new byte[1024];
                string msg = null;

                try
                {
                    NetworkStream ns = clientSocket.GetStream();
                    ns.Read(buf, 0, buf.Length);
                    msg = Encoding.UTF8.GetString(buf);

                    // 여기부터 받아오는 버퍼의 종류마다 다르게 처리.
                    RecvRegist(msg);
                }
                catch { }
            }
        }

        private void RecvRegist(string msg)
        {
            string[] msgArray = msg.Split('/');
            // regist/학번/비밀번호/이름/성별/연락처
            if (msgArray[0] == "regist")
            {
                for (int i = 0; i < serverForm.member.Count; i++)
                {
                    if (serverForm.member[i].classNumber == msgArray[1])
                    {
                        // 학번 중복일때
                        try
                        {
                            NetworkStream ns = clientSocket.GetStream();
                            string response = "fail";
                            byte[] buf = Encoding.UTF8.GetBytes(response);
                            ns.Write(buf, 0, buf.Length);
                            ns.Flush();
                        }
                        catch { }

                        return;
                    }
                }
                // 중복이 안될경우
                try
                {
                    NetworkStream ns = clientSocket.GetStream();
                    string response = "pass";
                    byte[] buf = Encoding.UTF8.GetBytes(response);
                    ns.Write(buf, 0, buf.Length);
                    ns.Flush();
                }
                catch { }

                clsPerson person = new clsPerson(msgArray[1], msgArray[2], msgArray[3], msgArray[4], msgArray[5]);
                serverForm.member.Add(person);
                serverForm.XMLSerialize(serverForm.member, "memberDB.xml");
            }
        }

        
    }
}
